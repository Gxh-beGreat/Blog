---
title: 关于动画，你需要知道
date: 2017-06-20 10:50:32
toc: true
mathjax: true
categories:
- JavaScript
tags:
- JavaScript
- 动画
---

-------

> [《关于动画，你需要知道的》](https://www.h5jun.com/post/animations-you-should-know.html?from=singlemessage&isappinstalled=0) 读后总结

-------

### 简单的 JS 动画
在浏览器里，动画实现的基本原理非常简单明了，其实就是 _采用定时器改变显示元素的一些属性的过程_。不管是 JavaScript 操作 DOM 的动画，还是 CSS3 动画，还是 Canvas 动画，或者 SVG 动画，区别只是使用的 API、何种定时器，影响什么环境（DOM/Canvas/SVG/WebGL）。

<a class="jsbin-embed" href="//code.h5jun.com/wev/6/embed?output">JS Bin on jsbin.com</a><script src="https:////code.h5jun.com/js/embed.min.js?3.40.2"></script>
```javascript
var deg = 0;
block.addEventListener("click", function(){
  var self = this;
  requestAnimationFrame(function change(){
    self.style.transform = "rotate(" + (deg++) +"deg)";
    requestAnimationFrame(change);
  });
});
```
上面例子使用了 定时器[requestAnimationFrame](https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame)，但是其并不是最佳的实现方法，下面让我们来解析其存在的问题:
1. 因为 `JavaScript` 是单线程，如果 `requestAnimationFrame` 被其他任务阻塞了，动画就会变慢(刷新率降低)
2. 假定每次触发 `requestAnimationFrame` 时间一定，我们通过上例 _定义速度_ 的方式来改变动画，会导致我们很难控制动画时间和动画的幅度，像前面这种匀速运动其实还好，如果做一些复杂的变速运动，按照我们的定义方式，我们本该设置的元素属性值将会类似于求积分，但是事实上时间又不连贯。

### 动画是“位移”关于“时间”的函数
动画，是 _位移关于时间的函数_ : \\(s = f(t)\\)  
所以，我们_不该_采用增量的方式来执行动画，为了更精确地控制动画，更合适的方式是_将动画与时间联系起来_

#### 动画与时间关联
```javascript
function startAnimation(){
  var startTime = Date.now();

  requestAnimationFrame(function change(){
    var current = Date.now() - startTime;

    console.log("动画已执行时间: %fms", current);

    requestAnimationFrame(change);
  });
}
```

#### 动画时间归一化表示
动画通常情况下有终止时间，如果是循环动画，我们也可以看做特殊的——当动画达到终止时间之后，重新开始动画。因此，我们可以将动画时间 _归一(Normalize)_ 表示：
```javascript
function startAnimation(duration, isLoop){
  var startTime = Date.now();

  requestAnimationFrame(function change(){
    // p => progress 动画进程数
    var p = (Date.now() - startTime) / duration;

    // 循环归一化
    if(p >= 1.0){
      if(isLoop){
        startTime += duration;
        p -= 1.0;
      }else{
        p = 1.0;
      }
    }

    console.log("动画已执行进度: %f", p);
    if(p < 1.0){
      requestAnimationFrame(change);
    }
  });
}
```

### 动画算子： easing
匀速运动、匀加速运动、匀减速运动、圆周运动唯一的区别仅仅在于位移方程：
* 匀速运动：\\(s_p = S \cdot P\\)
* 匀加速运动：\\(s_p = S \cdot P^2\\)
* 匀减速运动：\\(s_p = S \cdot P \cdot (2 - P)\\)
* 圆周运动x轴：\\(s_p = S \cdot cos(ωt)\\)
* 圆周运动y轴：\\(s_p = S \cdot sin(ωt)\\)

\\(s_p\\) 为当前位移量， \\(S\\) 为动画总位移量， \\(P\\) 为动画进程

我们把共同的部分 S 去掉，得到一个关于 p 的方程 \\(e_p = E(p)\\)，这个方程我们称为动画的算子(easing)，它决定了动画的性质。
* 匀速算子：\\(e_p = P\\)
* 匀加速算子：\\(e_p = P^2\\)
* 匀减速算子：\\(e_p = P \cdot (2 - P)\\)
* 圆周算子x轴： \\(e_p = cos(ωt)\\)
* 圆周算子y轴： \\(e_p = sin(ωt)\\)

### 总结
自己曾尝试过写惯性动画，之前的方案是按照增量方式进行，但因为动画涉及元素多，计算量大，导致在一些机型会特别的卡（当然不排除代码问题），昨天在翻阅 [iScroll](https://github.com/cubiq/iscroll) 源码的时候，才了解到了 _动画量子(easing)_ 的存在，在阅读完这篇文章后，对 _动画量子_ 又有了进一步的理解，之后将继续跟随这篇文章，对js动画做一个简易封装。

> 原文链接 [《关于动画，你需要知道的》](https://www.h5jun.com/post/animations-you-should-know.html?from=singlemessage&isappinstalled=0)
